<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Taiwan Trip - Pro Sync</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ⚠️ 請在此填入你的 Firebase Config ⚠️
        const firebaseConfig = {
            apiKey: "AIzaSyBYnROoZixE4LbeOlbxXCOs9TUUxHy8qn0",
            authDomain: "taiwantrip2026-b1e8f.firebaseapp.com",
            databaseURL: "https://taiwantrip2026-b1e8f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "taiwantrip2026-b1e8f",
            storageBucket: "taiwantrip2026-b1e8f.firebasestorage.app",
            messagingSenderId: "692934699626",
            appId: "1:692934699626:web:f86c1f01a864ee5391b813"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        const { createApp, ref: vRef, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const lang = vRef(localStorage.getItem('app_lang') || 'zh');
                const activeTab = vRef('itinerary');
                const selectedDay = vRef(1);
                const isSyncing = vRef(true);
                const exchangeRate = vRef(24.2);
                const itinerary = vRef([]);
                const expenses = vRef([]);
                const newExp = vRef({ name: '', amt: null, currency: 'TWD' });

                const i18n = {
                    zh: { title: 'Taiwan Trip', live: '● 同步中', add: '新增', del_msg: '確定要刪除嗎？', loc_p: '地點名稱...', total: '總結算 (SGD)', rate: '預估匯率', payer: '付款人', amt: '金額', confirm: '確認新增', settle: '結算方案', list_title: '支出明細', day: 'Day', lang_btn: 'EN' },
                    en: { title: 'Taiwan Trip', live: '● LIVE', add: 'Add', del_msg: 'Delete?', loc_p: 'Location...', total: 'Total (SGD)', rate: 'Rate', payer: 'Name', amt: 'Amount', confirm: 'Confirm', settle: 'Settlement', list_title: 'History', day: 'Day', lang_btn: '繁中' }
                };

                const t = (key) => i18n[lang.value][key];
                const toggleLang = () => { lang.value = lang.value === 'zh' ? 'en' : 'zh'; localStorage.setItem('app_lang', lang.value); };

                const dbItinerary = ref(db, 'itinerary');
                const dbExpenses = ref(db, 'expenses');

                onMounted(() => {
                    onValue(dbItinerary, (snap) => { itinerary.value = snap.val() ? Object.values(snap.val()) : []; isSyncing.value = false; refreshIcons(); });
                    onValue(dbExpenses, (snap) => { expenses.value = snap.val() ? Object.values(snap.val()) : []; refreshIcons(); });
                    fetch('https://open.er-api.com/v6/latest/SGD').then(r => r.json()).then(d => exchangeRate.value = d.rates.TWD.toFixed(2));
                });

                // --- 行程功能 ---
                const addItem = () => { const newRef = push(dbItinerary); set(newRef, { id: newRef.key, day: selectedDay.value, time: '10:00', loc: '' }); };
                const updateItem = (item) => update(ref(db, `itinerary/${item.id}`), item);
                const deleteItem = (id) => { if(confirm(t('del_msg'))) remove(ref(db, `itinerary/${id}`)); };

                // --- 分帳功能升級 ---
                const addExp = () => {
                    if(!newExp.value.name || !newExp.value.amt) return;
                    const rate = newExp.value.currency === 'SGD' ? 1 : exchangeRate.value;
                    const sgdAmt = newExp.value.amt / rate;
                    const newRef = push(dbExpenses);
                    set(newRef, { id: newRef.key, payer: newExp.value.name, amount: newExp.value.amt, currency: newExp.value.currency, sgdAmt: sgdAmt });
                    newExp.value = { name: '', amt: null, currency: 'TWD' };
                };

                const updateExpense = (exp) => {
                    const rate = exp.currency === 'SGD' ? 1 : exchangeRate.value;
                    exp.sgdAmt = exp.amount / rate;
                    update(ref(db, `expenses/${exp.id}`), exp);
                };

                const deleteExpense = (id) => { if(confirm(t('del_msg'))) remove(ref(db, `expenses/${id}`)); };

                const filteredItinerary = computed(() => itinerary.value.filter(i => i.day === selectedDay.value).sort((a,b) => a.time.localeCompare(b.time)));
                const totalSgd = computed(() => expenses.value.reduce((s, e) => s + e.sgdAmt, 0));

                const settlements = computed(() => {
                    const bal = {}; expenses.value.forEach(e => bal[e.payer] = (bal[e.payer] || 0) + e.sgdAmt);
                    const names = Object.keys(bal); if(names.length < 2) return [];
                    const avg = totalSgd.value / names.length;
                    let d = [], c = []; names.forEach(n => { let diff = bal[n] - avg; if(diff > 0) c.push({n, amt: diff}); else if(diff < 0) d.push({n, amt: Math.abs(diff)}); });
                    let res = [], i = 0, j = 0;
                    while(i < d.length && j < c.length) {
                        let p = Math.min(d[i].amt, c[j].amt); res.push({from: d[i].n, to: c[j].n, amt: p.toFixed(2)});
                        d[i].amt -= p; c[j].amt -= p; if(d[i].amt < 0.01) i++; if(c[j].amt < 0.01) j++;
                    }
                    return res;
                });

                const refreshIcons = () => setTimeout(() => lucide.createIcons(), 50);
                watch([activeTab, selectedDay, lang], refreshIcons);

                return { t, lang, toggleLang, activeTab, selectedDay, isSyncing, filteredItinerary, addItem, updateItem, deleteItem, expenses, newExp, addExp, updateExpense, deleteExpense, totalSgd, settlements, exchangeRate };
            }
        }).mount('#app');
    </script>

    <style>
        :root { --tiffany: #81D8D0; --bg: #F4F7F6; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); }
        .tiffany-bg { background-color: var(--tiffany); }
        .tiffany-text { color: var(--tiffany); }
        .date-active { background-color: var(--tiffany); color: white; transform: scale(1.05); box-shadow: 0 4px 12px rgba(129, 216, 208, 0.3); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); }
    </style>
</head>
<body class="text-slate-600">
    <div id="app" class="max-w-md mx-auto min-h-screen bg-[#F4F7F6] shadow-2xl flex flex-col relative overflow-hidden text-sm">
        
        <header class="p-8 pb-4 bg-white">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight text-slate-800">{{ t('title') }}</h1>
                    <p class="text-[10px] tiffany-text font-bold mt-1 uppercase tracking-widest">{{ t('live') }}</p>
                </div>
                <div class="flex gap-3">
                    <button @click="toggleLang" class="text-[10px] font-bold border-b-2 border-[#81D8D0] pb-0.5">{{ t('lang_btn') }}</button>
                    <button v-if="activeTab==='itinerary'" @click="addItem" class="tiffany-bg text-white p-2.5 rounded-xl shadow-lg active:scale-95 transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <div class="flex overflow-x-auto hide-scrollbar gap-4 py-2">
                <div v-for="n in 7" :key="n" @click="selectedDay = n"
                     :class="selectedDay === n ? 'date-active' : 'bg-white text-slate-300 border border-slate-100'"
                     class="flex-shrink-0 w-12 h-12 rounded-xl flex flex-col items-center justify-center transition-all cursor-pointer">
                    <span class="text-xs font-bold">{{n}}</span>
                </div>
            </div>
        </header>

        <main class="flex-1 px-6 pb-32 pt-4 overflow-y-auto">
            <div v-if="activeTab === 'itinerary'" class="space-y-4">
                <div v-for="item in filteredItinerary" :key="item.id" class="bg-white p-5 rounded-3xl card-shadow border border-white flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <input type="time" v-model="item.time" @change="updateItem(item)" class="text-xs font-bold tiffany-text bg-slate-50 px-2 py-1 rounded-lg outline-none">
                        <button @click="deleteItem(item.id)" class="text-slate-200 hover:text-red-300 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <input v-model="item.loc" @blur="updateItem(item)" :placeholder="t('loc_p')" class="w-full text-base font-medium outline-none bg-transparent">
                </div>
            </div>

            <div v-if="activeTab === 'split'" class="space-y-6">
                <div class="tiffany-bg p-8 rounded-[2rem] text-white shadow-xl">
                    <p class="text-[10px] opacity-80 uppercase tracking-widest mb-1">{{ t('total') }}</p>
                    <h2 class="text-4xl font-bold tracking-tighter mb-1">S$ {{ totalSgd.toFixed(2) }}</h2>
                    <p class="text-[9px] opacity-70 italic">1 SGD ≈ {{exchangeRate}} TWD</p>
                </div>

                <div class="bg-white p-6 rounded-3xl card-shadow space-y-4">
                    <div class="flex gap-2">
                        <input v-model="newExp.name" :placeholder="t('payer')" class="flex-1 bg-slate-50 p-3 rounded-xl outline-none border-none">
                        <select v-model="newExp.currency" class="bg-slate-50 p-3 rounded-xl text-xs font-bold tiffany-text outline-none">
                            <option value="TWD">TWD</option>
                            <option value="SGD">SGD</option>
                        </select>
                    </div>
                    <input v-model.number="newExp.amt" type="number" :placeholder="t('amt')" class="w-full bg-slate-50 p-3 rounded-xl outline-none">
                    <button @click="addExp" class="w-full tiffany-bg text-white py-4 rounded-2xl text-xs font-bold uppercase tracking-widest shadow-lg active:scale-95 transition-all">{{ t('confirm') }}</button>
                </div>

                <div class="space-y-3">
                    <p class="text-[10px] text-slate-300 font-bold uppercase tracking-widest px-2">{{ t('list_title') }}</p>
                    <div v-for="e in expenses" :key="e.id" class="bg-white p-4 rounded-2xl card-shadow flex flex-col gap-2">
                        <div class="flex justify-between items-center text-xs">
                            <input v-model="e.payer" @blur="updateExpense(e)" class="font-bold text-slate-700 bg-transparent outline-none">
                            <button @click="deleteExpense(e.id)" class="text-slate-200 hover:text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                        <div class="flex justify-between items-end">
                            <div class="flex items-center gap-1">
                                <input v-model.number="e.amount" @blur="updateExpense(e)" type="number" class="text-lg font-bold tiffany-text w-20 bg-slate-50 px-2 rounded outline-none">
                                <span class="text-[10px] text-slate-400 font-bold">{{ e.currency }}</span>
                            </div>
                            <span class="text-xs text-slate-300 italic">≈ S$ {{ e.sgdAmt.toFixed(2) }}</span>
                        </div>
                    </div>
                </div>

                <div v-if="settlements.length > 0" class="space-y-2 pt-4">
                    <p class="text-[10px] text-slate-300 font-bold uppercase tracking-widest px-2">{{ t('settle') }}</p>
                    <div v-for="s in settlements" class="flex justify-between items-center p-4 bg-emerald-50 rounded-2xl">
                        <span class="text-xs font-medium">{{s.from}} → {{s.to}}</span>
                        <span class="font-bold text-emerald-600">S$ {{s.amt}}</span>
                    </div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-6 left-6 right-6 max-w-md mx-auto h-18 rounded-[2rem] glass-nav shadow-xl border border-white flex justify-around items-center px-10 z-50">
            <button @click="activeTab = 'itinerary'" :class="activeTab === 'itinerary' ? 'tiffany-text' : 'text-slate-300'"><i data-lucide="map-pin"></i></button>
            <button @click="activeTab = 'split'" :class="activeTab === 'split' ? 'tiffany-text' : 'text-slate-300'"><i data-lucide="coins"></i></button>
        </nav>
    </div>
</body>
</html>
